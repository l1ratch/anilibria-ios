name: Build AniLiberty iOS IPA

on:
  #push:
    #branches: [ "master" ]
  #pull_request:
    #branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      SCHEME: AniLiberty
      WORKSPACE: Anilibria.xcworkspace
      EXPORT_OPTIONS_PLIST: ExportOptions.plist
      BUILD_PATH: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gems
        run: |
          sudo gem install xcpretty cocoapods

      - name: Install CocoaPods dependencies
        run: |
          pod install --project-directory=.

      - name: Build iOS Archive
        run: |
          mkdir -p $BUILD_PATH
          xcodebuild clean archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -archivePath "$BUILD_PATH/$SCHEME.xcarchive" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO | xcpretty

      - name: Export unsigned IPA for personal signing
        run: |
          mkdir -p $BUILD_PATH/ipa
          xcodebuild -exportArchive \
            -archivePath "$BUILD_PATH/$SCHEME.xcarchive" \
            -exportPath "$BUILD_PATH/ipa" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO | xcpretty

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: AniLiberty-unsigned
          path: $BUILD_PATH/ipa/*.ipa
          if-no-files-found: warn
          compression-level: 6
          overwrite: true
